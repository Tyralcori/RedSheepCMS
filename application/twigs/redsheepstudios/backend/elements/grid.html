<script type="text/javascript">
    // Placeholder
    var gridster;

    $(function() {
        // Grid system - Based on http://gridster.net/ (Awesome!!)
        redSheepGridHandling = {
            // Some vars
            widgetMarginHeight: 3,
            widgetMarginWidth: 3,
            widgetHeight: 100,
            widgetWidth: 100,
            gridColMin: 4,
            gridColMax: {{ rsGridConfigElements.width }},
            gridRowMin: 4,
            gridRowMax: {{ rsGridConfigElements.height }},
            gridCounter: 0,
            gridLoadedID: 0,
            widgetResizeable: true,
            widgetContainer: Array(),
            // Saves the grid
            save: function() {
                // Serialize the grid
                var serial = gridster.serialize();
                
                // Include grid infos
                var grid = redSheepGridHandling.widgetContainer;

                // Ajax reuqest to handle
                $.ajax({
                    type: "POST",
                    dataType: "JSON",
                    url: "/backend/grid/save",
                    data: {save: serial, gridContainer: grid, gridID: redSheepGridHandling.gridLoadedID},
                    success: function(msg) {
                        // Replace alert with a nice auto hiding message
                        alert(msg.message);
                    }
                });
            },
            // Load all grid id
            load: function() {
                // Clear the options
                $('#gridID').html('');
                
                // Ajax Request to handle
                $.ajax({
                    type: "POST",
                    dataType: "JSON",
                    url: "/backend/grid/load",
                    success: function(msg) {
                        // Fill selectbox
                        $.each($.parseJSON(msg.message), function(key, value) {
                            $("#gridID").append('<option value=' + value +  '>' + value + '</option>');
                        });
                        // Call picker modal
                        $('#gridSelector').modal();
                    }
                });
            },
            // Load a grid by id
            loadGridByID: function() {
                // Ajax Request to handle
                $.ajax({
                    type: "POST",
                    dataType: "JSON",
                    data: {load: $("#gridID").val()},
                    url: "/backend/grid/load",
                    success: function(msg) {
                        // Clear grid
                        redSheepGridHandling.killAll();
                        
                        // Set grid id
                        redSheepGridHandling.gridLoadedID = $("#gridID").val();
                        
                        // Get loaded grid
                        var loadedGrid = msg.message;

                        // Generate grid
                        $.each($.parseJSON(loadedGrid), function(key, value){
                            
                            // Fill container
                            redSheepGridHandling.widgetContainer[key] = parseInt(value.widgetID);
                            
                            // Add widget by following: html, width, height, col, row
                            gridster.add_widget('<li class="new grid-' + redSheepGridHandling.gridCounter + '">' +
                            '<a class="killItem" href="javascript:javascript:redSheepGridHandling.killItem(' + redSheepGridHandling.gridCounter + ');">X</a>' +
                            redSheepGridHandling.gridCounter +
                            '</li>', value.size_x, value.size_y, value.col, value.row);
                    
                            // Plus one
                            redSheepGridHandling.gridCounter = parseInt(redSheepGridHandling.gridCounter) + 1;
                        });
                        

                    }
                });
            },
            // Spawn new item
            spawnItem: function(elementType) {
                // Set widget container
                redSheepGridHandling.widgetContainer[redSheepGridHandling.gridCounter] = elementType;
                console.log(redSheepGridHandling.widgetContainer);
                // Pattern for adding new widget
                gridster.add_widget('<li class="new grid-' + redSheepGridHandling.gridCounter + '">' +
                        '<a class="killItem" href="javascript:javascript:redSheepGridHandling.killItem(' + redSheepGridHandling.gridCounter + ');">X</a>' +
                        elementType +
                        '</li>', 1, 1);

                // Plus one
                redSheepGridHandling.gridCounter = parseInt(redSheepGridHandling.gridCounter) + 1;
            },
            // Kill item by number
            killItem: function(number) {
                // Unset in widget container
                redSheepGridHandling.widgetContainer[number] = '';
                
                // Unset in grid
                gridster.remove_widget(document.getElementsByClassName('grid-' + number));
            },
            // "Clear" grid
            killAll: function() {
                // Container
                redSheepGridHandling.widgetContainer = Array();
                
                // Clear
                gridster.remove_all_widgets();

                // Reset counter
                redSheepGridHandling.gridCounter = 0;
            },
            // Reload the grid
            reload: function() {
                redSheepGridHandling.killAll();
                redSheepGridHandling.init();
            },
            // Init whole grid
            init: function() {
                // Create gridster var
                gridster = $(".gridster ul").gridster({
                    widget_margins: [redSheepGridHandling.widgetMarginWidth, redSheepGridHandling.widgetMarginHeight],
                    widget_base_dimensions: [redSheepGridHandling.widgetHeight, redSheepGridHandling.widgetWidth],
                    min_cols: redSheepGridHandling.gridColMin,
                    min_rows: redSheepGridHandling.gridRowMin,
                    max_cols: redSheepGridHandling.gridColMax,
                    max_rows: redSheepGridHandling.gridRowMax,
                    resize: {
                        enabled: redSheepGridHandling.widgetResizeable
                    },
                    autogenerate_stylesheet: true,
                }).data('gridster');
            }

        };

        // Register Event on "loadSelectedGrid"
        $('.loadSelectedGrid').click(function() {
            redSheepGridHandling.loadGridByID();
            $('.hideModal').click();
        });

        // Reload Grid
        redSheepGridHandling.init();
    });
</script>
<div class="gridPanel">
    
    <p class="gridPanelHead">ELEMENTS</p>
    {% for widget in rsGridWidgetElements %}
        <a href="javascript:redSheepGridHandling.spawnItem('{{ widget.type }}');">{{ widget.name }}</a><br/>
    {% endfor %}
       
    <hr/>
    
    <p class="gridPanelHead">OVERVIEW</p>
    <a href="javascript:redSheepGridHandling.save()">Save Grid</a>

    <br/><a href="javascript:redSheepGridHandling.load()">Load Grid</a>

    <br/><a href="javascript:redSheepGridHandling.reload()">Reload Grid</a>   
</div>
<div class="gridster">
    <ul></ul>
</div>

<div id="gridSelector" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSelector" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Load grid</h4>
            </div>
            <div class="modal-body">
                <select id="gridID" name="gridID" class="form-control"></select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default hideModal" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary loadSelectedGrid">Load selected grid</button>
            </div>
        </div>
    </div>
</div>